<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="leasecity.repo.commentRepo">
 	
 	<!-- 게시물 전체갯수 조회 -->
 	<select id="getCountAllComments" resultType="int">
 		SELECT COUNT(*) FROM comments
 	</select>
 	
 	<!-- 게시물 페이지별 조회 - 검색,정렬 포함 -->
 	<select id="getPageSelectComment" parameterType="page" resultType="comment">
 		SELECT *
 		FROM (
 				SELECT sub.*, rownum AS comment_row_num,
 				SUBSTR(comment_category, 0, INSTR(comment_category, '/')-1) AS locale,
 				SUBSTR(comment_category, INSTR(comment_category, '/')+1, LENGTH(comment_category)) AS kind
 				FROM( SELECT * FROM comments
 					<choose>
	 					<when test="search == 'TITLE' and keyword != null">
	 						WHERE comment_title LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%'
	 					</when>
	 					<when test="search == 'COMPANY_NAME' and keyword != null">
	 						WHERE company_name LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%'
	 					</when>
	 					<when test="search == 'TITLE_AND_CONTENT' and keyword != null">
	 						WHERE comment_title LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%' OR
	 						comment_content LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%'
	 					</when>
	 					<when test="search == 'LOCAL' and keyword != null">
	 						WHERE comment_category LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%' 
	 					</when>
 					</choose>
 					
 					<choose>
 						<when test="order == 'ASC'">
 							ORDER BY reg_date ASC
 						</when>
 						
 						<when test="order == 'DESC' or order == null">
 							ORDER BY reg_date DESC
 						</when>
 					</choose>
 					) sub
 				)
 		<if test="pageSize != null and to !=null and from != null">
 			WHERE comment_row_num BETWEEN #{to} AND #{from}
 		</if>		
 	</select>
 	
 	<!-- 게시물 페이지별 조회 - 검색 정렬한 게시물의 갯수 -->
 	<select id="getPageSelectCommentCount" parameterType="page" resultType="int">
 		SELECT COUNT(*)
 		FROM (
 				SELECT sub.*, rownum AS comment_row_num 				
 				 				FROM( SELECT * FROM comments 
 					<choose>
	 					<when test="search == 'TITLE' and keyword != null">
	 						WHERE comment_title LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%'
	 					</when>
	 					<when test="search == 'COMPANY_NAME' and keyword != null">
	 						WHERE user_id LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%'
	 					</when>
	 					<when test="search == 'TITLE_AND_CONTENT' and keyword != null">
	 						WHERE comment_title LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%' OR
	 						comment_content LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%'
	 					</when>
	 					<when test="search == 'LOCAL' and keyword != null">
	 						WHERE comment_category LIKE '%'||REPLACE(#{keyword}, ' ', '%')||'%' 
	 					</when>
 					</choose>
 					) sub
 				)		
 	</select>
 	
 	<!-- 게시글 번호에 대한 게시글 검색 조회 -->
 	<select id="getSelectComment" parameterType="int" resultType="comment">
 		SELECT *
 		FROM comments
 		WHERE comment_no = #{commentNo}
 	</select>
 	
 	
 	<!-- 게시물 추가 -->
 	<!-- comment_no는 TRIGGER로 AUTO_INCREMENT취급 받음 -->
 	<insert id="insertComment" parameterType="comment">
 		INSERT INTO comments 
 		(user_id, comment_title, 
 		comment_category, comment_content)
 		VALUES(#{userId}, #{commentTitle},
 		#{commentCategory},#{commentContent}) 
 	</insert>
 	
 	<!-- 게시물 삭제 - 종속성에 의해 댓글도 같이 자동삭제 -->
 	<delete id="deleteCommentAndReply" parameterType="comment">
 		DELETE FROM comments
 		WHERE comment_no = #{commentNo}
 	</delete>
 	
 	<!-- 게시물 수정 -->
 	<update id="updateComment" parameterType="comment">
 		UPDATE comments SET
 		comment_title = #{commentTitle},
 		comment_category = #{commentCategory},
 		comment_content = #{commentContent} 		
 		WHERE comment_no = #{commentNo}
 	</update>
 
 </mapper>